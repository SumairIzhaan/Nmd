<meta name='viewport' content='width=device-width, initial-scale=1'/>import React, { useState, useEffect } from 'react';
import { Mic, Copy, Edit2, Check, X, Play, Square } from 'lucide-react';

const VoiceOrderEntry = () => {
  const [clients, setClients] = useState([
    'MIDC', 'Parbhakar', 'Abrar', 'Durg', 'Brahmapuri', 'Mr. K', 'Shri Ram',
    'Wayne', 'A1', 'Nikhil', 'Mohan', 'Ratna', 'Sawner', 'Khalsa', 'Khaparkheda',
    'Mishraji', 'Rasta', 'Chillar', 'Mamu', 'Devlapar', 'Suraj',
    'Katol gold', 'Anand Soda', 'Khamla', 'Kamthi', 'LG', 'Wardha', 'Manewada',
    'Ballarsha', 'Anuj dairy', 'Daryapur', 'Moseen pulgaon', 'Rc', 'Radhe wardha',
    'Patel saab', 'Nova'
  ]);
  const [newClientName, setNewClientName] = useState('');
  const [showAddClient, setShowAddClient] = useState(false);

  const [orders, setOrders] = useState(() => {
    const saved = {};
    clients.forEach(client => saved[client] = 0);
    return saved;
  });
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isListening, setIsListening] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [currentDate, setCurrentDate] = useState(new Date().toLocaleDateString('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  }));
  const [recognition, setRecognition] = useState(null);

  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recog = new SpeechRecognition();
      recog.continuous = false;
      recog.interimResults = false;
      recog.lang = 'en-IN';

      recog.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const number = parseInt(transcript.match(/\d+/)?.[0] || '0');
        
        if (!isNaN(number)) {
          const client = clients[currentIndex];
          setOrders(prev => ({ ...prev, [client]: number }));
          
          if (currentIndex < clients.length - 1) {
            setCurrentIndex(prev => prev + 1);
            setTimeout(() => {
              if (isListening) {
                recog.start();
              }
            }, 500);
          } else {
            setIsListening(false);
          }
        }
      };

      recog.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (isListening && currentIndex < clients.length - 1) {
          setTimeout(() => recog.start(), 500);
        }
      };

      recog.onend = () => {
        if (isListening && currentIndex < clients.length - 1) {
          setTimeout(() => recog.start(), 500);
        }
      };

      setRecognition(recog);
    }
  }, [currentIndex, isListening]);

  const startVoiceEntry = () => {
    if (recognition) {
      setIsListening(true);
      setCurrentIndex(0);
      recognition.start();
    } else {
      alert('Speech recognition is not supported in your browser. Please use Chrome.');
    }
  };

  const stopVoiceEntry = () => {
    setIsListening(false);
    if (recognition) {
      recognition.stop();
    }
  };

  const totalPieces = Object.values(orders).reduce((sum, val) => sum + val, 0);
  const totalCrates = (totalPieces / 6).toFixed(2);

  const formatForWhatsApp = () => {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowDate = tomorrow.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
    
    let text = `\tToday's Date: ${tomorrowDate}\t\t\n\t\t\t\n\tClient\tOrder\t\n`;
    
    clients.forEach(client => {
      const order = orders[client];
      const spacing = '\t'.repeat(Math.max(1, 3 - Math.floor(client.length / 8)));
      text += `\t${client}.${spacing}=\t${order}\t\n`;
    });
    
    text += `\tTotal pieces       =\t${totalPieces}\t\n`;
    text += `\tTotal Crates  =\t${totalCrates}(${totalPieces}Ã·6)`;
    
    return text;
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(formatForWhatsApp());
    alert('Order copied to clipboard! You can paste it in WhatsApp now.');
  };

  const resetOrders = () => {
    const reset = {};
    clients.forEach(client => reset[client] = 0);
    setOrders(reset);
    setCurrentIndex(0);
  };

  const addNewClient = () => {
    if (newClientName.trim() && !clients.includes(newClientName.trim())) {
      setClients(prev => [...prev, newClientName.trim()]);
      setOrders(prev => ({ ...prev, [newClientName.trim()]: 0 }));
      setNewClientName('');
      setShowAddClient(false);
    }
  };

  const removeClient = (clientName) => {
    if (confirm(`Remove ${clientName} from the list?`)) {
      setClients(prev => prev.filter(c => c !== clientName));
      setOrders(prev => {
        const newOrders = { ...prev };
        delete newOrders[clientName];
        return newOrders;
      });
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-6">
        <h1 className="text-3xl font-bold text-center mb-6 text-indigo-600">
          ðŸ“¦ NMD Orders
        </h1>

        <div className="mb-6 flex gap-4 justify-center flex-wrap">
          {!isListening ? (
            <button
              onClick={startVoiceEntry}
              className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition"
            >
              <Play size={20} /> Start Voice Entry
            </button>
          ) : (
            <button
              onClick={stopVoiceEntry}
              className="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition"
            >
              <Square size={20} /> Stop
            </button>
          )}
          
          <button
            onClick={() => setEditMode(!editMode)}
            className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition"
          >
            {editMode ? <Check size={20} /> : <Edit2 size={20} />}
            {editMode ? 'Done Editing' : 'Edit Orders'}
          </button>
          
          <button
            onClick={copyToClipboard}
            className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition"
          >
            <Copy size={20} /> Copy for WhatsApp
          </button>
          
          <button
            onClick={resetOrders}
            className="flex items-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition"
          >
            <X size={20} /> Reset All
          </button>

          <button
            onClick={() => setShowAddClient(!showAddClient)}
            className="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition"
          >
            {showAddClient ? <X size={20} /> : '+'} {showAddClient ? 'Cancel' : 'Add Client'}
          </button>
        </div>

        {showAddClient && (
          <div className="mb-6 p-4 bg-orange-50 border-2 border-orange-300 rounded-lg">
            <label className="block text-sm font-semibold mb-2">New Client Name:</label>
            <div className="flex gap-2">
              <input
                type="text"
                value={newClientName}
                onChange={(e) => setNewClientName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addNewClient()}
                placeholder="Enter client name"
                className="flex-1 p-2 border-2 border-gray-300 rounded-lg"
              />
              <button
                onClick={addNewClient}
                className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold"
              >
                Add
              </button>
            </div>
          </div>
        )}

        {isListening && (
          <div className="mb-6 p-4 bg-green-100 border-2 border-green-500 rounded-lg text-center">
            <div className="flex items-center justify-center gap-2 mb-2">
              <Mic className="animate-pulse text-red-500" size={24} />
              <span className="text-lg font-semibold">Listening for: {clients[currentIndex]}</span>
            </div>
            <div className="text-sm text-gray-600">Say the quantity number...</div>
          </div>
        )}

        <div className="mb-6">
          <label className="block text-sm font-semibold mb-2">Date:</label>
          <input
            type="text"
            value={currentDate}
            onChange={(e) => setCurrentDate(e.target.value)}
            className="w-full p-2 border-2 border-gray-300 rounded-lg"
          />
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-h-96 overflow-y-auto p-2">
          {clients.map((client, idx) => (
            <div
              key={client}
              className={`p-3 rounded-lg border-2 transition relative ${
                idx === currentIndex && isListening
                  ? 'border-green-500 bg-green-50'
                  : 'border-gray-300 bg-gray-50'
              }`}
            >
              <button
                onClick={() => removeClient(client)}
                className="absolute top-1 right-1 text-red-500 hover:text-red-700 text-xs"
                title="Remove client"
              >
                âœ•
              </button>
              <div className="font-semibold text-gray-700 mb-1">{client}</div>
              {editMode ? (
                <input
                  type="number"
                  value={orders[client]}
                  onChange={(e) => setOrders(prev => ({ ...prev, [client]: parseInt(e.target.value) || 0 }))}
                  className="w-full p-2 border border-gray-300 rounded"
                />
              ) : (
                <div className="text-2xl font-bold text-indigo-600">{orders[client]}</div>
              )}
            </div>
          ))}
        </div>

        <div className="bg-indigo-50 p-4 rounded-lg">
          <div className="text-xl font-bold text-gray-800 mb-2">
            Total Pieces: <span className="text-indigo-600">{totalPieces}</span>
          </div>
          <div className="text-xl font-bold text-gray-800">
            Total Crates: <span className="text-indigo-600">{totalCrates}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VoiceOrderEntry;